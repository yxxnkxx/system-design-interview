# 5장 안정 해시 설계

## 해시 키 재배치(rehash) 문제

N개의 캐시 서버가 있을 때 부하를 균등하게 나누는 방법

```
serverIndex = hash(key) % N(서버 수)
```

- 서버 풀의 크기 고정
- 데이터 분포 균등

할 때 잘 동작한다

- 서버 추가
- 기존 서버 삭제

시 문제가 생긴다

## 안정 해시

해시 테이블 크기가 조정될 때 평균적으로 오직 k/n개의 키만 재배치하는 해시 기술
- k: 키의 수
- n: 슬롯의 수

*대부분의 전통적 해시 테이블: 슬롯의 수가 바뀌면 대부분 키를 재배치

### 해시 공간과 해시 링

해시 링: 해시 공간의 양쪽을 구부려 접는다 (x0~xn)

### 해시 서버

해시 함수 f를 사용하여 서버를 해시 링 위에 배치

### 해시 키

해시 키도 해시 링 위의 지점에 배치

### 서버 조회

키가 저장되는 서버: 해당 키의 위치로부터 시계 방향으로 링을 탐색하여 만나는 첫 번째 서버

![image](https://github.com/yxxnkxx/system-design-interview/assets/109255398/83c260b1-59cd-449e-a0d1-20939114dc35)

### 서버 추가, 서버 제거

키 가운데 일부만 재배치됨

- 추가/제거되는 서버 주변 키만 재배치

### 기본 구현법의 두 가지 문제

안정 해시 알고리즘
- 서버와 키를 균등 분포 해시 함수를 사용해 해시 링에 배치
- 키의 위치에서 링을 시계 방향으로 탐색하다 만나는 최초의 서버에 키 저장

문제점
- 서버가 추가/제거될 때 파티션의 크기 균등 유지가 불가능
- 키의 균등 분포 달성이 어려움

### 가상 노드

가상 노드: 실제 노드, 서버를 가리키는 노드
- 하나의 서버는 링 위에 여러 개의 가상 노드를 가질 수 있다

![image](https://github.com/yxxnkxx/system-design-interview/assets/109255398/de2ff8a7-9905-416e-a185-3957eb566325)

각 서버는 여러 개 파티션을 관리

가상 노드의 개수를 늘리면 키의 분포가 균등해진다

+ 가상 노드 데이터를 저장할 공간이 더 많이 필요함

- trade off 필요

### 재배치할 키 결정

서버가 추가, 제거되면 데이터 일부를 재배치

- 서버 추가: 새로 추가된 노드부터 그 반시계 방향에 있는 첫 번째 서버까지 (새로 추가된 서버로 배치)
- 서버 삭제: 삭제된 노드부터 그 반시계 방향에 있는 최초 서버 사이에 있는 키를 재배치